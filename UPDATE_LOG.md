# 🎉 最新功能更新

## ✨ 新增功能：钢琴卷帘播放进度条

### 功能说明

在钢琴卷帘窗口中添加了实时播放进度显示功能，让你可以清晰地看到当前播放位置。

### 主要特性

#### 1. **可视化进度条** 🎯
- **红色进度线**：垂直线条标记当前播放位置
- **三角形标记**：顶部和底部的三角形指示器，更易识别
- **阴影效果**：进度线带有柔和阴影，视觉效果更佳

#### 2. **已播放区域高亮** 📍
- 播放过的区域显示淡红色半透明遮罩
- 直观区分已播放和未播放的音符

#### 3. **实时时间显示** ⏱️
- 进度线上方显示当前播放时间（分:秒格式）
- 红色标签背景，白色文字，清晰易读

#### 4. **自动滚动跟随** 🔄
- 播放时，视图自动向右滚动
- 进度条始终保持在视口中心偏左位置
- 无需手动拖动，自动跟随播放进度

#### 5. **智能重置** 🔙
- 播放结束后自动滚动回起始位置
- 暂停后恢复播放，从暂停位置继续

## 🎮 完整操作指南

### 基本操作

| 操作 | 功能 | 说明 |
|------|------|------|
| **鼠标滚轮** | 左右滑动 | 水平滚动浏览音符 |
| **Shift + 滚轮** | 上下滑动 | 垂直滚动查看不同音高 |
| **Ctrl + 滚轮** | 水平缩放 | 放大/缩小时间轴 |
| **点击音符** | 编辑+试听 | 切换状态并播放该音符 |
| **拖拽框选** | 批量选择 | 选择多个音符进行批量操作 |

### 播放控制

| 功能 | 说明 |
|------|------|
| **▶ 播放** | 开始播放/从暂停位置继续 |
| **⏸ 暂停** | 暂停播放，保留当前位置 |
| **进度条** | 顶部蓝色进度条，点击跳转 |
| **速度调节** | ± 按钮，0.25x - 2.0x 可调 |
| **Solo Melody** | 只播放旋律部分 |

### 编辑功能

| 功能 | 说明 |
|------|------|
| **单击音符** | 切换旋律/伴奏状态 |
| **框选音符** | 选中后点击按钮批量设置 |
| **音符试听** | 点击音符立即播放该音高 |
| **实时统计** | 显示旋律/伴奏/总计数量 |

### 导出功能

| 功能 | 说明 |
|------|------|
| **💾 导出分轨** | 生成 melody.mid + accompaniment.mid（ZIP 打包） |
| **🔤 转 Token** | 导出 JSON 格式的 Token 序列（支持复合/简单格式） |

## 🎨 视觉效果

### 颜色编码
- 🟢 **绿色** = 旋律音符 (is_melody: true)
- ⚫ **灰色** = 伴奏音符 (is_melody: false)
- 🟡 **黄色** = 选中状态
- 🔴 **红色** = 播放进度线和已播放区域

### 进度显示
```
┌──────────────────────────────────────┐
│ 🔺 0:15                               │  ← 时间标签
│ │                                     │
│ │ 🟢🟢🟢 ⚫⚫⚫ 🟢🟢               │
│ │                                     │
│ │                                     │
│ 🔻                                    │
└──────────────────────────────────────┘
  ↑                                     
已播放区域（淡红色遮罩）
```

## 💡 使用技巧

### 1. 播放时导航
- 播放开始后，视图会自动跟随进度滚动
- 你仍然可以使用滚轮手动调整视图
- 暂停后可以编辑，恢复播放继续跟随

### 2. 精确定位
- 使用顶部进度条快速跳转到特定位置
- 钢琴卷帘中的红色进度线更精确
- 配合缩放功能查看细节

### 3. 高效编辑
1. 播放一遍，观察自动识别结果
2. 暂停在需要修改的位置
3. 编辑音符（点击切换状态）
4. 继续播放验证效果

### 4. 调试技巧
- 开启 Solo Melody 模式单独听旋律
- 调整播放速度慢速检查
- 使用框选批量修正错误识别

## 🔧 技术实现

### 前端更新
- **PianoRoll.vue**：
  - 新增 `currentTime` 和 `isPlaying` props
  - 实现 `drawProgressLine()` 绘制进度条
  - 实现 `autoScroll()` 自动滚动逻辑
  - Watch `currentTime` 触发重新渲染

- **App.vue**：
  - 传递 `currentTime` 和 `isPlaying` 给子组件
  - 播放时实时更新 `currentTime` (50ms 间隔)

### 渲染优化
- 进度条使用 Canvas 绘制，性能高效
- 只在可见区域绘制，避免不必要的计算
- 自动滚动使用平滑算法，视觉流畅

## 🎯 下一步建议

### 可能的增强功能
- [ ] 键盘快捷键支持（空格=播放/暂停）
- [ ] 循环播放模式
- [ ] 导出视频功能（录制钢琴卷帘播放过程）
- [ ] 多轨编辑支持
- [ ] 和弦识别功能
- [ ] MIDI 效果器（混响、延迟等）

### Token 化应用
详见 [MIDI_TO_TOKEN.md](MIDI_TO_TOKEN.md) 获取完整的机器学习应用指南。

## 📚 相关文档

- [项目 README](README.md) - 项目整体说明
- [MIDI to Token](MIDI_TO_TOKEN.md) - Token 化详细文档
- [API 文档](http://localhost:8000/docs) - FastAPI 自动生成的 API 文档

## 🎉 开始使用

1. 确保后端和前端都在运行
2. 访问 http://localhost:3000
3. 上传一个 MIDI 文件
4. 点击播放，观看进度条效果！

享受你的音乐创作之旅！🎵
